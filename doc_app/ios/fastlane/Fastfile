default_platform(:ios)

platform :ios do
  desc "Build iOS App and Distribute via Firebase App Distribution"
  lane :iOS_Distribution do
    # Clean and build Flutter iOS app (from ios directory, go to root)
    sh "cd .. && flutter clean"
    sh "cd .. && flutter build ios --release --flavor production --target lib/main_production.dart --no-codesign"
    
    # Create IPA from the .app file
    sh "mkdir -p ../build/ios/Payload"
    sh "cp -R ../../build/ios/iphoneos/DocDoc-Release-Production.app ../build/ios/Payload/"
    sh "cd ../build/ios && zip -r DocDoc-Production.ipa Payload/"
    
    # Distribute via Firebase
    firebase_app_distribution(
      app: "ENV['IOS_APP_ID']",
      testers: "adelaboali82@gmail.com",
      firebase_cli_token: ENV['FIREBASE_CLI_TOKEN'],
      ipa_path: "../build/ios/DocDoc-Production.ipa",
      release_notes: "SadioZmano iOS Build"
    )
  end
end

